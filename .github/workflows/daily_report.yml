name: Daily Project Report

on:
  schedule:
    - cron: '0 19 * * *' 
  workflow_dispatch: 

jobs:
  post-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Run Report Script
        # THIS IS THE FIX: Passing the token to your NPM script
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_TOKEN }}
          GITHUB_OWNER: "Gaia-Digital-Agency"
        run: |
          npm run report-all > report.md

      - name: Post Comment to Discussion
        env:
          GH_TOKEN: ${{ secrets.REPORT_TOKEN }}
        run: |
          # 1. Get the Discussion ID
          DISCUSSION_ID=$(gh api graphql -f query='
            query($org: String!, $num: Int!) {
              organization(login: $org) {
                repository(name: ".github") {
                  discussion(number: $num) {
                    id
                  }
                }
              }
            }' -f org="Gaia-Digital-Agency" -F num=2 --jq '.data.organization.repository.discussion.id')

          # 2. Post the report.md content
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                comment {
                  url
                }
              }
            }' -f discussionId=$DISCUSSION_ID -F body=@report.md