name: Daily Project Report

on:
  schedule:
    - cron: '0 19 * * 4'
  workflow_dispatch:

jobs:
  post-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Run Report Script
        env:
          GITHUB_TOKEN: ${{ secrets.REPORT_TOKEN }}
          GITHUB_OWNER: "Gaia-Digital-Agency"
        run: |
          # Run the script
          npm run report-all

          # Find the most recent report and move it to standard filename
          LATEST_REPORT=$(ls -t reports/all_projects_portfolio_*.md | head -n 1)
          cp "$LATEST_REPORT" final_report.md

          # Append team mention and timestamp
          echo -e "\n\n---\n**Last Updated:** $(date)\n**Cc:** @Gaia-Digital-Agency/developers" >> final_report.md

      - name: Clear Chat and Post Fresh Report
        env:
          GH_TOKEN: ${{ secrets.REPORT_TOKEN }}
          ORG: "Gaia-Digital-Agency"
          REPO: ".github"
          DISCUSSION_NUM: 1
        run: |
          echo "Fetching IDs for Discussion #$DISCUSSION_NUM..."

          # 1. Get the Discussion ID and all current comment IDs
          DISCUSSION_DATA=$(gh api graphql -f query='
            query($org: String!, $repo: String!, $num: Int!) {
              repository(owner: $org, name: $repo) {
                discussion(number: $num) {
                  id
                  comments(first: 100) {
                    nodes { id }
                  }
                }
              }
            }' -f org="$ORG" -f repo="$REPO" -F num=$DISCUSSION_NUM)

          DISCUSSION_ID=$(echo "$DISCUSSION_DATA" | jq -r '.data.repository.discussion.id // empty')
          
          if [ -z "$DISCUSSION_ID" ] || [ "$DISCUSSION_ID" == "null" ]; then
            echo "Error: Could not find Discussion #$DISCUSSION_NUM"
            exit 1
          fi

          # 2. Extract Comment IDs and delete them one by one
          COMMENT_IDS=$(echo "$DISCUSSION_DATA" | jq -r '.data.repository.discussion.comments.nodes[].id // empty')

          for ID in $COMMENT_IDS; do
            if [ ! -z "$ID" ] && [ "$ID" != "null" ]; then
              echo "Deleting old content: $ID"
              gh api graphql -f query='
                mutation($id: ID!) {
                  deleteDiscussionComment(input: {id: $id}) {
                    clientMutationId
                  }
                }' -f id=$ID
            fi
          done

          # 3. Post the fresh report
          echo "Posting the fresh daily report..."
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                comment { url }
              }
            }' -f discussionId=$DISCUSSION_ID -F body=@final_report.md