name: Daily Project Report

on:
  schedule:
    - cron: '0 19 * * *' # 7:00 PM UTC
  workflow_dispatch: # This adds the "Run workflow" button manually

jobs:
  post-report:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Run Report Script
        run: npm run report-all > report.md

      - name: Post Comment to Discussion
        env:
          # Use your PAT (REPORT_TOKEN) if you couldn't change Org settings
          # Otherwise, use GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.REPORT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # This command finds the Discussion ID for discussion #2 in your Org
          DISCUSSION_ID=$(gh api graphql -f query='
            query($org: String!, $num: Int!) {
              organization(login: $org) {
                repository(name: ".github") {
                  discussion(number: $num) {
                    id
                  }
                }
              }
            }' -f org="Gaia-Digital-Agency" -F num=2 --jq '.data.organization.repository.discussion.id')

          # Post the content of the generated report.md
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                comment {
                  url
                }
              }
            }' -f discussionId=$DISCUSSION_ID -F body=@report.md